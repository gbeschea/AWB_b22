{% extends "_layout.html" %}
{% block title %}SetÄƒri Curieri - AWB Hub{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ul>
            <li><a href="{{ url_for('get_settings_page') }}">SetÄƒri</a></li>
            <li>Curieri</li>
        </ul>
    </nav>
    <h1>ðŸšš SetÄƒri Curieri</h1>
    <p>AdaugÄƒ È™i configureazÄƒ conturile de curier, adresele de expeditor, profilele de expediÈ›ie È™i mapÄƒrile din Shopify.</p>
    <hr>

    <h2>Conturi de Curier È™i Expeditori</h2>
    <article>
        <h3>AdaugÄƒ un cont/expeditor nou</h3>
        <form action="{{ url_for('create_courier_account') }}" method="post">
            
            <fieldset>
                <legend>InformaÈ›ii Cont</legend>
                <div class="grid">
                    <div>
                        <label for="accName">Nume Cont*</label>
                        <input type="text" id="accName" name="name" placeholder="Ex: DPD Romania (Sediu Central)" required>
                    </div>
                    <div>
                        <label for="accKey">Cheie UnicÄƒ*</label>
                        <input type="text" id="accKey" name="account_key" placeholder="Ex: dpd-ro-hq" required>
                    </div>
                    <div>
                        <label for="accType">Tip Curier*</label>
                        <select id="accType" name="courier_type" required onchange="showCourierFields(this.value, 'new')">
                            <option value="" disabled selected>Alege tipul</option>
                            <option value="sameday">Sameday</option>
                            <option value="dpd">DPD</option>
                            <option value="econt">Econt</option>
                        </select>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>AdresÄƒ Expeditor</legend>
                <div class="grid">
                    <div>
                        <label for="contactName">Nume Contact*</label>
                        <input type="text" id="contactName" name="contact_name" required>
                    </div>
                    <div>
                        <label for="phone">Telefon*</label>
                        <input type="tel" id="phone" name="phone" required>
                    </div>
                    <div>
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email">
                    </div>
                </div>
                <label for="addressLine1">AdresÄƒ (stradÄƒ, nr., etc.)*</label>
                <input type="text" id="addressLine1" name="address_line1" required>
                
                <div class="grid">
                    <div>
                        <label for="city">OraÈ™*</label>
                        <input type="text" id="city" name="city" required>
                    </div>
                     <div>
                        <label for="county">JudeÈ›*</label>
                        <input type="text" id="county" name="county" required>
                    </div>
                    <div>
                        <label for="postcode">Cod PoÈ™tal*</label>
                        <input type="text" id="postcode" name="postcode" required>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>CredenÈ›iale API</legend>
                <div id="fields-new-sameday" class="courier-fields" style="display:none;">
                    <input type="text" name="sameday_username" placeholder="Sameday Username">
                    <input type="password" name="sameday_password" placeholder="Sameday Password">
                </div>
                <div id="fields-new-dpd" class="courier-fields" style="display:none;">
                    <input type="text" name="dpd_username" placeholder="DPD Username">
                    <input type="password" name="dpd_password" placeholder="DPD Password">
                    <input type="text" name="dpd_client_id" placeholder="DPD Client ID">
                </div>
                <div id="fields-new-econt" class="courier-fields" style="display:none;">
                    <input type="text" name="econt_username" placeholder="Econt Username">
                    <input type="password" name="econt_password" placeholder="Econt Password">
                </div>
            </fieldset>
            
            <button type="submit">AdaugÄƒ Cont</button>
        </form>
    </article>

    <h3>Conturi Salvate</h3>
    <table>
        <thead>
            <tr>
                <th>Nume Cont</th>
                <th>Cheie</th>
                <th>Tip</th>
                <th>AdresÄƒ Expeditor</th>
                <th>AcÈ›iuni</th>
            </tr>
        </thead>
        <tbody>
        {% for acc in accounts %}
            <tr>
                <td><strong>{{ acc.name }}</strong></td>
                <td><code>{{ acc.account_key }}</code></td>
                <td><span class="tag">{{ acc.courier_type | upper }}</span></td>
                <td>
                    {% if acc.credentials and acc.credentials.sender_address %}
                        {{ acc.credentials.sender_address.contact_person }}, {{ acc.credentials.sender_address.street }}, {{ acc.credentials.sender_address.city }}
                    {% else %}
                        <span style="color: #999;">FÄƒrÄƒ adresÄƒ</span>
                    {% endif %}
                </td>
                <td>
                    <a href="{{ url_for('edit_courier_account_page', account_id=acc.id) }}" role="button" class="secondary outline">
                        EditeazÄƒ
                    </a>
                </td>
            </tr>
        {% else %}
            <tr><td colspan="5" style="text-align: center;">Nu existÄƒ conturi de curier configurate.</td></tr>
        {% endfor %}
        </tbody>
    </table>
    <hr>
    
   <h2 id="profiles">ðŸ“¦ Profile de ExpediÈ›ie (È˜abloane)</h2>
<article>
    <h3>AdaugÄƒ un profil nou</h3>
    <form action="{{ url_for('create_shipment_profile') }}" method="post">
        
        <div class="grid">
            <div>
                <label for="profileName">Nume Profil*</label>
                <input type="text" id="profileName" name="name" placeholder="Ex: DPD Standard - Colet Mic" required>
            </div>
            <div>
                <label for="profileAccount">Cont de curier asociat*</label>
                <select id="profileAccount" name="account_key" required>
                    <option value="" disabled selected>Alege un cont</option>
                    {% for acc in accounts %}<option value="{{ acc.account_key }}">{{ acc.name }}</option>{% endfor %}
                </select>
            </div>
        </div>

        <fieldset><legend>SetÄƒri È˜ablon pentru Expediere</legend>
            <div class="grid">
                <div>
                    <label for="default_parcels">Nr. colete implicit</label>
                    <input type="number" id="default_parcels" name="default_parcels" value="1">
                </div>
                <div>
                    <label for="default_weight_kg">Greutate implicitÄƒ (kg)</label>
                    <input type="number" id="default_weight_kg" name="default_weight_kg" value="1.0" step="0.1">
                </div>
            </div>
            <label>Dimensiuni implicite (cm)</label>
            <div class="grid">
                <div><input type="number" name="default_length_cm" placeholder="Lungime (L)"></div>
                <div><input type="number" name="default_width_cm" placeholder="LÄƒÈ›ime (l)"></div>
                <div><input type="number" name="default_height_cm" placeholder="ÃŽnÄƒlÈ›ime (h)"></div>
            </div>
            <hr>
            <div class="grid">
                <div>
                    <label for="default_service_id">Serviciu Implicit DPD (opÈ›ional)</label>
                    <select id="default_service_id" name="default_service_id">
                        <option value="">-- Nespecificat --</option>
                        <option value="2505">2505: DPD STANDARD</option>
                        <option value="2005">2005: CARGO NATIONAL</option>
                        <option value="2212">2212: DPD REGIONAL CEE</option>
                        <option value="2214">2214: CARGO REGIONAL</option>
                        <option value="2303">2303: DPD INTERNATIONAL (RUTIER)</option>
                    </select>
                </div>
                 <div>
                    <label for="content_template">Format ConÈ›inut Colet</label>
                    <input type="text" id="content_template" name="content_template" value="${orderName} / ${quantity} x ${sku}" maxlength="30">
                </div>
            </div>
        </fieldset>
        
        <button type="submit">SalveazÄƒ Profilul</button>
    </form>
</article>


    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Profile Salvate
        </div>

        <div class="card-body">
            <table class="table table-bordered table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nume Profil</th>
                        <th>Cont Curier Asociat</th>
                        <th>AcÈ›iuni</th>
                    </tr>
                </thead>
                <tbody>
                {% for profile in shipment_profiles %}
                <tr>
                    <td>{{ profile.id }}</td>
                    <td>{{ profile.name }}</td>
                    <td>{{ profile.account_key }}</td>
                    <td>
                    <a href="{{ url_for('edit_shipment_profile_page', profile_id=profile.id) }}" role="button" class="btn btn-sm btn-primary">
                        EditeazÄƒ
                    </a>
                    <form action="{{ url_for('delete_shipment_profile', profile_id=profile.id) }}" method="post" style="display:inline"
                            onsubmit="return confirm('Sigur vrei sÄƒ È™tergi profilul {{ profile.name }}?');">
                        <button class="btn btn-sm btn-danger">È˜terge</button>
                    </form>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center">Nu existÄƒ profile salvate.</td>
                </tr>
                {% endfor %}
                </tbody>


            </table>
        </div>
    </div>

    <hr>

    <h2>MapÄƒri Shopify</h2>
    <article>
        <h3>AdaugÄƒ o mapare nouÄƒ</h3>
        <form action="{{ url_for('create_courier_mapping') }}" method="post">
            <div class="grid">
                <input type="text" name="shopify_name" placeholder="Nume livrare Ã®n Shopify" required>
                <select name="account_key" required>
                    <option value="" disabled selected>Alege un cont</option>
                    {% for acc in accounts %}<option value="{{ acc.account_key }}">{{ acc.name }} ({{ acc.account_key }})</option>{% endfor %}
                </select>
            </div>
            <button type="submit">AdaugÄƒ Mapare</button>
        </form>
    </article>
    <table>
        <thead><tr><th>Nume Shopify</th><th>Cont Mapat</th></tr></thead>
        <tbody>
        {% for mapping in mappings %}
        <tr>
            <td>{{ mapping.shopify_name }}</td>
            <td><code>{{ mapping.account_key }}</code></td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
    // Am eliminat din scriptul tÄƒu partea cu `tracking_url` care nu mai existÄƒ Ã®n formular
    function showCourierFields(courierType, formId) {
        document.querySelectorAll('.courier-fields').forEach(el => el.style.display = 'none');
        const fieldsToShow = document.getElementById('fields-' + formId + '-' + courierType);
        if (fieldsToShow) {
            // Am schimbat Ã®n 'grid' pentru o aliniere mai bunÄƒ
            fieldsToShow.style.display = 'grid'; 
            fieldsToShow.style.gap = '1rem';
        }
    }
</script>
{% endblock %}