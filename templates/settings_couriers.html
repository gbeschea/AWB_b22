{% extends "_layout.html" %}
{% block title %}SetÄƒri Curieri - AWB Hub{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ul>
            <li><a href="{{ url_for('get_settings_page') }}">SetÄƒri</a></li>
            <li>Curieri</li>
        </ul>
    </nav>
    <h1>ðŸšš SetÄƒri Curieri</h1>
    <p>AdaugÄƒ È™i configureazÄƒ conturile de curier È™i cum sunt mapate din Shopify.</p>
    <hr>

    <h2>Conturi de Curier</h2>
    <article>
        <h3>AdaugÄƒ un cont nou</h3>
        <form action="{{ url_for('create_courier_account') }}" method="post">
            <div class="grid">
                <input type="text" name="name" placeholder="Nume afiÈ™at (ex: DPD Romania)" required>
                <input type="text" name="account_key" placeholder="Cheie unicÄƒ (ex: dpd-ro)" required>
                <select name="courier_type" required onchange="showCourierFields(this.value, 'new')">
                    <option value="" disabled selected>Alege tipul de curier</option>
                    <option value="sameday">Sameday</option>
                    <option value="dpd">DPD</option>
                    <option value="econt">Econt</option>
                </select>
            </div>
            <input type="text" name="tracking_url" placeholder="URL Tracking (se completeazÄƒ automat)">

            <div id="fields-new-sameday" class="courier-fields" style="display:none;">
                <label>CredenÈ›iale Sameday</label>
                <div class="grid">
                    <input type="text" name="cred_username" placeholder="Utilizator Sameday">
                    <input type="password" name="cred_password" placeholder="ParolÄƒ Sameday">
                </div>
                <div class="grid">
                    <input type="number" name="cred_pickup_point_id" placeholder="ID Punct de Ridicare">
                    <input type="number" name="cred_default_service_id" placeholder="ID Serviciu Implicit">
                </div>
                 <div class="grid">
                    <input type="text" name="cred_default_package_type" placeholder="Tip Colet Implicit">
                    <input type="text" name="cred_awb_payment" placeholder="Plata AWB (Client/Expeditor)">
                </div>
            </div>

            <div id="fields-new-dpd" class="courier-fields" style="display:none;">
                <label>CredenÈ›iale DPD</label>
                <div class="grid">
                    <input type="text" name="cred_username" placeholder="Utilizator DPD">
                    <input type="password" name="cred_password" placeholder="ParolÄƒ DPD">
                </div>
                <div class="grid">
                    <input type="text" name="cred_clientSecret" placeholder="Client Secret">
                    <input type="text" name="cred_pickupOfficeId" placeholder="ID Oficiu Ridicare">
                </div>
            </div>
            
            <div id="fields-new-econt" class="courier-fields" style="display:none;">
                <label>CredenÈ›iale Econt</label>
                <div class="grid">
                    <input type="text" name="cred_username" placeholder="Utilizator Econt">
                    <input type="password" name="cred_password" placeholder="ParolÄƒ Econt">
                </div>
                <label><input type="checkbox" name="cred_test_mode" role="switch"> Mod Test</label>
            </div>
            
            <button type="submit">AdaugÄƒ Cont</button>
        </form>
    </article>
    
    {% for acc in accounts %}
    <details>
        <summary><strong>{{ acc.name }}</strong> - <code>{{ acc.account_key }}</code></summary>
        <form action="{{ url_for('update_courier_account', account_id=acc.id) }}" method="post">
            <div class="grid">
                <input type="text" name="name" value="{{ acc.name }}" required>
                <input type="text" name="account_key" value="{{ acc.account_key }}" required>
                <input type="text" name="courier_type" value="{{ acc.courier_type }}" readonly>
            </div>
            <input type="text" name="tracking_url" value="{{ acc.tracking_url }}">

            {% if acc.courier_type == 'sameday' %}
            <div class="courier-fields">
                <label>CredenÈ›iale Sameday</label>
                <div class="grid">
                    <input type="text" name="cred_username" value="{{ acc.credentials.get('username', '') }}" placeholder="Utilizator Sameday">
                    <input type="password" name="cred_password" value="" placeholder="{{ 'ParolÄƒ setatÄƒ. LasÄƒ gol pentru a nu schimba.' if acc.credentials.get('password') else 'ParolÄƒ Sameday' }}">
                </div>
                <div class="grid">
                    <input type="number" name="cred_pickup_point_id" value="{{ acc.credentials.get('pickup_point_id', '') }}" placeholder="ID Punct de Ridicare">
                    <input type="number" name="cred_default_service_id" value="{{ acc.credentials.get('default_service_id', '') }}" placeholder="ID Serviciu Implicit">
                </div>
                 <div class="grid">
                    <input type="text" name="cred_default_package_type" value="{{ acc.credentials.get('default_package_type', '') }}" placeholder="Tip Colet Implicit">
                    <input type="text" name="cred_awb_payment" value="{{ acc.credentials.get('awb_payment', '') }}" placeholder="Plata AWB">
                </div>
            </div>
            {% endif %}

            {% if acc.courier_type == 'dpd' %}
            <div class="courier-fields">
                <label>CredenÈ›iale DPD</label>
                <div class="grid">
                    <input type="text" name="cred_username" value="{{ acc.credentials.get('username', '') }}" placeholder="Utilizator DPD">
                    <input type="password" name="cred_password" value="" placeholder="{{ 'ParolÄƒ setatÄƒ. LasÄƒ gol pentru a nu schimba.' if acc.credentials.get('password') else 'ParolÄƒ DPD' }}">
                </div>
                <div class="grid">
                    <input type="text" name="cred_clientSecret" value="{{ acc.credentials.get('clientSecret', '') }}" placeholder="Client Secret">
                    <input type="text" name="cred_pickupOfficeId" value="{{ acc.credentials.get('pickupOfficeId', '') }}" placeholder="ID Oficiu Ridicare">
                </div>
            </div>
            {% endif %}

            {% if acc.courier_type == 'econt' %}
            <div class="courier-fields">
                <label>CredenÈ›iale Econt</label>
                 <div class="grid">
                    <input type="text" name="cred_username" value="{{ acc.credentials.get('username', '') }}" placeholder="Utilizator Econt">
                    <input type="password" name="cred_password" value="" placeholder="{{ 'ParolÄƒ setatÄƒ. LasÄƒ gol pentru a nu schimba.' if acc.credentials.get('password') else 'ParolÄƒ Econt' }}">
                </div>
                <label><input type="checkbox" name="cred_test_mode" role="switch" {% if acc.credentials.get('test_mode') %}checked{% endif %}> Mod Test</label>
            </div>
            {% endif %}
            
            <select name="is_active">
                <option value="true" {% if acc.is_active %}selected{% endif %}>Activ</option>
                <option value="false" {% if not acc.is_active %}selected{% endif %}>Inactiv</option>
            </select>
            <button type="submit">ActualizeazÄƒ</button>
        </form>
    </details>
    {% endfor %}

    <hr>
    <h2>MapÄƒri Shopify</h2>
    <article>
        <h3>AdaugÄƒ o mapare nouÄƒ</h3>
        <form action="{{ url_for('create_courier_mapping') }}" method="post">
            <div class="grid">
                <input type="text" name="shopify_name" placeholder="Nume din Shopify (ex: DPD Jaragua)" required>
                <select name="account_key" required>
                    <option value="" disabled selected>Alege un cont</option>
                    {% for acc in accounts %}<option value="{{ acc.account_key }}">{{ acc.name }} ({{ acc.account_key }})</option>{% endfor %}
                </select>
            </div>
            <button type="submit">AdaugÄƒ Mapare</button>
        </form>
    </article>

    <table>
        <thead><tr><th>Nume Shopify</th><th>Cont Mapat</th></tr></thead>
        <tbody>
        {% for mapping in mappings %}
        <tr>
            <td>{{ mapping.shopify_name }}</td>
            <td><code>{{ mapping.account_key }}</code></td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<script>
    const defaultUrls = {{ default_tracking_urls | tojson }};

    function showCourierFields(courierType, formId) {
        document.querySelectorAll('#fields-' + formId + ' .courier-fields, .courier-fields[id^="fields-' + formId + '-"]').forEach(function(el) {
            el.style.display = 'none';
        });
        
        var fieldsToShow = document.getElementById('fields-' + formId + '-' + courierType);
        if (fieldsToShow) {
            fieldsToShow.style.display = 'block';
        }

        if (formId === 'new') {
            const trackingUrlInput = document.querySelector('form[action="{{ url_for('create_courier_account') }}"] input[name="tracking_url"]');
            if (trackingUrlInput) {
                trackingUrlInput.value = defaultUrls[courierType] || '';
            }
        }
    }
</script>
{% endblock %}